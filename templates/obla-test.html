<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTION OBLA-Test</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/FRwbMSBN/SENTION-logo-Black-Transparent-BG.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
       body {
    font-family: 'Roboto', sans-serif;
    background: #f0eeec;
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    padding-bottom: 200px; /* Added padding to ensure content doesn't overlap with logo */
    background-attachment: fixed;
    position: relative;
}

header {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: right;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    background-color: #ffffff;
    position: relative;
    border-radius: 15px 15px 15px 15px;
    font-family: 'Verdana', sans-serif; /* Ändra till önskad font */
    font-size: 0.9rem; /* Ändra storlek om det behövs */
    font-weight: medium; /* Ändra tjocklek om det behövs */
    padding-left: 100px; /* Adjust this value to move text more or less to the right */
    padding-top: 10px;
}

.logo-container {
    position: absolute;
    left: 320px;
    top: 49px;
}

.logo-container img {
    height: 30px;
    border-radius: 5px 5px 5px 5px;
}

h1 {
height: 107px;
color: #444444;
font-family: 'Verdana', sans-serif;
font-size: 2.5rem;
font-weight: bold;
display: flex;          
align-items: center;     
margin: 0;             
font-family: 'Rajdhani';
font-weight: 500; 
}

table {
    margin-bottom: 30px;
    border-collapse: collapse;
    width: 90%;
    max-width: 1200px;
    background-color: #c0c0c0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

th, td {
    border: none;
    padding: 14px;
    text-align: center;
    color: #333;
    font-size: 1.05rem;
}

th {
    background-color: #d0d0d0;
}

td {
    background-color: #e0e0e0;
}

input[type="number"] {
    background-color: #f0f0f0;
    border: none;
    color: #333;
    text-align: center;
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    font-size: 1.05rem;
}

input[type="number"]:focus {
    outline: none;
    box-shadow: 0 0 5px #00bcd4;
}

#chartContainer {
    width: 90%;
    max-width: 1200px;
    background-color: #ffffff;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(102, 101, 101, 0.3);
    border-radius: 8px;
    margin-top: 40px; /* Added margin to move the chart down */
    margin-bottom: 60px;
}

#thresholdTable {
    margin-top: 0px; /* Changed margin to 0px */
}

.controls {
    margin-bottom: 25px;
    width: 90%;
    max-width: 1200px;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
}

#controls {
    background-color: #f8f9fa; /* Light gray background */
    border: 1px solid #ccc;
    border-radius: 7px;
}

.controls label {
    margin-right: 10px;
    color: #333;
}

.btn {
    background-color: #d6d2ce;
    border: none;
    color: #333;
    padding: 12px 24px;
    border-radius: 6px;
    transition: background-color 0.3s ease;
    margin-top: 8px;
    margin-bottom: 8px;
    font-size: 1.05rem;
}

.btn:hover {
    background-color: #b4aca4;
}

.mb-3 {
    width: 90%; /* Adjust this value to your desired width */
    max-width: 1200px; /* Optional: set a maximum width */
    margin: 0 auto; /* Center the container */
}

.weight-container {
    width: 30%;
    max-width: 250px;
    margin: 0 auto;
    margin-bottom: 15px;
}

#weightInput,
#horizontalLine1,
#horizontalLine2,
#verticalLine1,
#verticalLine2 {
    background-color: #f8f9fa; /* Light gray background */
    border: 1px solid #ccc;
    border-radius: 7px;
}

#commentInput {
    width: 100%; /* Make the textarea fill the container */
    min-height: 70px;
    padding: 12px;
    border-radius: 4px;
    border: 1px solid #ccc;
    overflow-y: hidden;
    resize: none;
    border-radius: 10px;
    font-size: 1.05rem;
}

.bottom-logo {
    position: fixed;
    bottom: 20px;
    right: 20px;
    height: 160px; /* Increased from 120px to 160px */
    border-radius: 3px;
    z-index: 1000;
}

.input-group {
    position: relative;
    margin: 10px;
}

.input-group input {
    font-size: 1.05rem;
    padding: 0.9rem;
    border: 1px solid #ccc;
    border-radius: 7px;
    width: 100%;
    background-color: #ffffff;
}

.input-group input {
    border-radius: 7px !important; /* Tvinga alla hörn att vara rundade */
}

.input-group input:focus {
    outline: none;
    border-color: #d3d0cc;
    box-shadow: 0 0 0 3px #F0EEEC;
}

.input-group label {
    position: absolute;
    left: 0.8rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
    pointer-events: none;
    transition: all 0.3s ease;
    font-size: 1.05rem;
    background: white;
    padding: 0 0.2rem;
}

.input-group input:focus ~ label,
.input-group input:not(:placeholder-shown) ~ label {
    top: -10px;
    left: 0.4rem;
    font-size: 0.85rem;
    color: #000000;
    background: white;
    padding: 0 0.2rem;
}

/* Specifika stilar för olika input-typer */
#dateInput,
#personnummerInput {
    width: 240px;
}

#nameInput {
    width: auto;
    min-width: 200px;
    max-width: none;
    text-align: left;
}

.input-row {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 30px;
    width: 100%;
    max-width: 1200px;
    margin: 25px auto;
}

        @media print {
    #weightSection, #dataTable, .controls, .btn {
        display: none; /* Hide unnecessary sections when printing */
    }
    #thresholdTable {
        display: table; /* Ensure the table is visible when printing */
        margin-top: 20px; /* Move the table down by 20px */
        page-break-before: always; /* Force the table to start on a new page */
    }
    
    #chartContainer {
        width: 80%; /* Adjust the width of the chart container */
        max-width: 800px; /* Optional: Set a maximum width for the chart */
        margin-top: 20px; /* Move the table down by 20px */
    }
    canvas {
        width: 100% !important; /* Ensure the canvas fits the container */
        height: auto !important; /* Maintain the aspect ratio */
    }
}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <header>
        <div class="logo-container">
        </div>
        <h1> SENTION - Onset of Blood Lactate Accumulation (Cykel)</h1>
        </div>
    </header>
    <div class="input-row">
        <div class="input-group">
            <input type="text" id="nameInput" placeholder=" " required>
            <label for="nameInput">Namn</label>
        </div>
        <div class="input-group">
            <input type="text" id="personnummerInput" placeholder=" " required>
            <label for="personnummerInput">Personnummer</label>
        </div>
        <div class="input-group">
            <input type="date" id="dateInput" placeholder=" " required>
            <label for="dateInput">Datum</label>
        </div>
    </div>
        </div>
</div>
    </div>
    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>
    <div class="weight-container" id="weightSection">
        <label for="weightInput" class="form-label">Vikt (kg):</label>
        <input type="number" id="weightInput" class="form-control" value="" oninput="updateTable()">
    </div>
    <table id="dataTable" class="table">
        <thead>
            <tr>
                <th>Belastning (Watt)</th>
                <th>Belastning (Watt/kg)</th>
                <th>Puls</th>
                <th>Laktat</th>
                <th>BORG</th> <!-- New column for BORG -->
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="number" oninput="calculateWattKg(this)"></td>
                <td><input type="number" readonly></td>
                <td><input type="number" oninput="updateChart()"></td>
                <td><input type="number" oninput="updateChart()"></td>
                <td><input type="number" oninput="updateChart()"></td>
            </tr>
            <tr>
                <td><input type="number" oninput="calculateWattKg(this)"></td>
                <td><input type="number" readonly></td>
                <td><input type="number" oninput="updateChart()"></td>
                <td><input type="number" oninput="updateChart()"></td>
                <td><input type="number" oninput="updateChart()"></td>
            </tr>
        </tbody>
    </table>
    
    <!-- Buttons for adding and removing rows -->
    <div>
        <button class="btn" onclick="addRow()">Lägg till rad</button>
        <button class="btn btn-danger" onclick="removeLastRow()">Ta bort rad</button>
    </div>
    <div class="controls">
        <div>
            <label for="horizontalLine1" class="form-label">Horisontell Linje (2 mmol):</label>
            <input type="number" id="horizontalLine1" class="form-control" value="2" step="0.1" oninput="updateAnnotations()">
        </div>
        <div>
            <label for="horizontalLine2" class="form-label">Horisontell Linje (4 mmol):</label>
            <input type="number" id="horizontalLine2" class="form-control" value="4" step="0.1" oninput="updateAnnotations()">
        </div>
        <div>
            <label for="verticalLine1" class="form-label">Vertikal Linje (2 mmol):</label>
            <input type="number" id="verticalLine1" class="form-control" value="1.8" step="0.01" oninput="updateAnnotations()">
        </div>
        <div>
            <label for="verticalLine2" class="form-label">Vertikal Linje (4 mmol):</label>
            <input type="number" id="verticalLine2" class="form-control" value="2.8" step="0.01" oninput="updateAnnotations()">
        </div>
    </div>
    <button class="btn" onclick="toggleVerticalLines()">På/Av Vertikala Linjer</button>
    <button class="btn" onclick="updateChart()">Uppdatera graf</button>
    
    <!-- Empty header for the threshold table -->
    <h3 style="margin-top: 60px; margin-bottom: 20px; color: #444444; font-family: 'Rajdhani', sans-serif; font-weight: 500; font-size: 2rem; text-align: center;">Tröskelvärden</h3>
    
    <table id="thresholdTable" class="table">
        <thead>
            <tr>
                <th>Trösklar</th>
                <th>Belastning (Watt)</th>
                <th>Belastning (Watt/kg)</th>
                <th>Puls</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>2.0 mMol/l</td>
                <td><input type="number" id="watt2" oninput="calculateThresholdWattKg(2)"></td>
                <td><input type="number" id="wattKg2" readonly></td>
                <td><input type="number" id="pulse2"></td>
            </tr>
            <tr>
                <td>4.0 mMol/l</td>
                <td><input type="number" id="watt4" oninput="calculateThresholdWattKg(4)"></td>
                <td><input type="number" id="wattKg4" readonly></td>
                <td><input type="number" id="pulse4"></td>
            </tr>
        </tbody>
    </table>
    <div class="mb-3">
        <h6>Kommentar:</h6>
        <textarea id="commentInput" placeholder="Skriv din kommentar här..."></textarea>
    </div>
    <div class="mb-3">
        <h6>Tolkat av:</h6>
        <select id="interpretedBy" class="form-select">
            <option value="Per Andersson">Överläkare Per "Pliggen" Andersson</option>
        </select>
    </div>
    <button class="btn" onclick="exportAsExcel()">Spara Excel</button>
    <button class="btn" onclick="exportDiagramAsPDF()">Spara Diagram som PDF</button>
    <button class="btn" onclick="exportThresholdTableAsPDF()">Spara Tröskelvärden som PDF</button>
    </div>
    <img src="https://i.postimg.cc/x1PkvmGq/SENTION-logo-Black-Transparent-BG.png" alt="Logo" class="bottom-logo">
    <script>
        const adjustInputWidth = (input) => {
    // Create a temporary span element to measure the text width
    const tempSpan = document.createElement('span');
    tempSpan.style.visibility = 'hidden';
    tempSpan.style.position = 'absolute';
    tempSpan.style.whiteSpace = 'nowrap';
    tempSpan.style.font = window.getComputedStyle(input).font; // Match the input's font
    tempSpan.textContent = input.value || input.placeholder;

    document.body.appendChild(tempSpan);

    // Calculate the new width, including padding and borders
    const padding = parseFloat(window.getComputedStyle(input).paddingLeft) +
                    parseFloat(window.getComputedStyle(input).paddingRight);
    const border = parseFloat(window.getComputedStyle(input).borderLeftWidth) +
                   parseFloat(window.getComputedStyle(input).borderRightWidth);
    const newWidth = tempSpan.offsetWidth + padding + border + 10; // Add extra padding for comfort

    input.style.width = `${newWidth}px`;

    document.body.removeChild(tempSpan);
};

// Attach the function to the "Namn" input
const nameInput = document.getElementById('nameInput');
nameInput.addEventListener('input', function () {
    adjustInputWidth(this);
});

// Initialize the width on page load
adjustInputWidth(nameInput);

        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Puls',
                    data: [],
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderWidth: 3,
                    yAxisID: 'y',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                }, {
                    label: 'Laktat',
                    data: [],
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderWidth: 3,
                    yAxisID: 'y2',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                }]
            },
            options: {
                responsive: true,
                devicePixelRatio: 2, // Improved resolution
                layout: {
                    padding: {
                        left: 20,
                        right: 50, // Increased padding on right for full visibility of all numbers
                        top: 20,
                        bottom: 20
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Belastning (Watt/kg)',
                            color: '#333',
                            font: {
                                family: 'Roboto',
                                size: 20,
                                weight: 'bold',
                                lineHeight: 1.2
                            },
                            padding: {top: 20}
                        },
                        ticks: {
                            color: '#333',
                            font: {
                                family: 'Roboto',
                                size: 14
                            },
                            maxTicksLimit: 8, // Prevent overcrowding
                            padding: 10
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 50,
                        suggestedMax: 200,
                        title: {
                            display: true,
                            text: 'Puls',
                            color: '#333',
                            font: {
                                family: 'Roboto',
                                size: 20,
                                weight: 'bold',
                                lineHeight: 1.2
                            },
                            padding: {top: 30}
                        },
                        ticks: {
                            color: '#333',
                            font: {
                                family: 'Roboto',
                                size: 14
                            }
                        }
                    },
                    y2: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        min: 0,
                        max: 5,
                        title: {
                            display: true,
                            text: 'Laktat',
                            color: '#333',
                            font: {
                                family: 'Roboto',
                                size: 20,
                                weight: 'bold',
                                lineHeight: 1.2
                            },
                            padding: {top: 30}
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            color: '#333',
                            font: {
                                family: 'Roboto',
                                size: 14
                            }
                        }
                    }
                },
                plugins: {
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: 2,
                                yMax: 2,
                                borderColor: 'rgba(0, 255, 0, 0.6)',
                                borderWidth: 3,
                                borderDash: [7, 7],
                                yScaleID: 'y2'
                            },
                            line2: {
                                type: 'line',
                                yMin: 4,
                                yMax: 4,
                                borderColor: 'rgba(0, 0, 255, 0.6)',
                                borderWidth: 3,
                                borderDash: [7, 7],
                                yScaleID: 'y2'
                            },
                            verticalLine1: {
                                type: 'line',
                                xMin: 1.8,
                                xMax: 1.8,
                                borderColor: 'rgba(255, 165, 0, 0.6)',
                                borderWidth: 3,
                                borderDash: [7, 7],
                                xScaleID: 'x',
                                display: false
                            },
                            verticalLine2: {
                                type: 'line',
                                xMin: 2.8,
                                xMax: 2.8,
                                borderColor: 'rgba(255, 165, 0, 0.6)',
                                borderWidth: 3,
                                borderDash: [7, 7],
                                xScaleID: 'x',
                                display: false
                            }
                        }
                    },
                    legend: {
                        labels: {
                            font: {
                                size: 14
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutBounce'
                }
            }
        });

        const calculateWattKg = (input) => {
            const row = input.closest('tr');
            const watt = parseFloat(input.value);
            const weight = parseFloat(document.getElementById('weightInput').value);
            const wattKgCell = row.cells[1].querySelector('input');
            wattKgCell.value = weight > 0 ? formatNumber(watt / weight) : '';
            updateChart();
        };

        const updateTable = () => {
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                calculateWattKg(row.cells[0].querySelector('input'));
            });
        };

        const updateChart = () => {
    const wattKgData = [], pulseData = [], lactateData = [];
    
    // Collect data from the table
    document.querySelectorAll('#dataTable tbody tr').forEach(row => {
        const cells = row.querySelectorAll('input');
        wattKgData.push(parseFloat(cells[1].value));
        pulseData.push(parseFloat(cells[2].value));
        lactateData.push(parseFloat(cells[3].value));
    });

    // Update chart data
    myChart.data.labels = wattKgData;
    myChart.data.datasets[0].data = pulseData.map(formatPulse);
    myChart.data.datasets[1].data = lactateData.map(formatNumber);

    // Dynamically calculate the min and max for the y2-axis (Laktat)
    const lactateMin = Math.min(...lactateData) - 0.5; // Add some padding
    const lactateMax = Math.max(...lactateData) + 0.5;

    // Update only the y2-axis (Laktat)
    myChart.options.scales.y2.min = lactateMin > 0 ? lactateMin : 0; // Ensure no negative values
    myChart.options.scales.y2.max = lactateMax;

    // Recalculate intersections
    const intersection1 = findIntersection(wattKgData, lactateData, 2);
    const intersection2 = findIntersection(wattKgData, lactateData, 4);

    // Update intersection values in the UI
    document.getElementById('verticalLine1').value = formatNumber(intersection1);
    document.getElementById('verticalLine2').value = formatNumber(intersection2);

    // Update threshold table and annotations
    updateThresholdTable(intersection1, intersection2, pulseData, wattKgData);
    updateAnnotations();

    // Update the chart
    myChart.update();
};

        const findIntersection = (wattKgData, lactateData, target) => {
            for (let i = 0; i < lactateData.length - 1; i++) {
                if ((lactateData[i] <= target && lactateData[i + 1] >= target) ||
                    (lactateData[i] >= target && lactateData[i + 1] <= target)) {
                    const x1 = wattKgData[i], x2 = wattKgData[i + 1];
                    const y1 = lactateData[i], y2 = lactateData[i + 1];
                    return x1 + (target - y1) * (x2 - x1) / (y2 - y1);
                }
            }
            return wattKgData[0];
        };

        const updateAnnotations = () => {
            const horizontalLine1Value = parseFloat(document.getElementById('horizontalLine1').value);
            const horizontalLine2Value = parseFloat(document.getElementById('horizontalLine2').value);
            const verticalLine1Value = parseFloat(document.getElementById('verticalLine1').value);
            const verticalLine2Value = parseFloat(document.getElementById('verticalLine2').value);

            myChart.options.plugins.annotation.annotations.line1.yMin = horizontalLine1Value;
            myChart.options.plugins.annotation.annotations.line1.yMax = horizontalLine1Value;
            myChart.options.plugins.annotation.annotations.line2.yMin = horizontalLine2Value;
            myChart.options.plugins.annotation.annotations.line2.yMax = horizontalLine2Value;
            myChart.options.plugins.annotation.annotations.verticalLine1.xMin = verticalLine1Value;
            myChart.options.plugins.annotation.annotations.verticalLine1.xMax = verticalLine1Value;
            myChart.options.plugins.annotation.annotations.verticalLine2.xMin = verticalLine2Value;
            myChart.options.plugins.annotation.annotations.verticalLine2.xMax = verticalLine2Value;

            myChart.update();
        };

        const updateThresholdTable = (intersection1, intersection2, pulseData, wattKgData) => {
            const weight = parseFloat(document.getElementById('weightInput').value);
            const watt2 = intersection1 * weight;
            const watt4 = intersection2 * weight;

            document.getElementById('watt2').value = formatNumber(watt2);
            document.getElementById('wattKg2').value = formatNumber(intersection1);
            document.getElementById('pulse2').value = formatPulse(getPulseAtIntersection(intersection1, wattKgData, pulseData));

            document.getElementById('watt4').value = formatNumber(watt4);
            document.getElementById('wattKg4').value = formatNumber(intersection2);
            document.getElementById('pulse4').value = formatPulse(getPulseAtIntersection(intersection2, wattKgData, pulseData));
        };

        const calculateThresholdWattKg = (threshold) => {
            const weight = parseFloat(document.getElementById('weightInput').value);
            const wattInput = document.getElementById(`watt${threshold}`);
            const wattKgInput = document.getElementById(`wattKg${threshold}`);
            const watt = parseFloat(wattInput.value);
            wattKgInput.value = weight > 0 ? formatNumber(watt / weight) : '';
        };

        const getPulseAtIntersection = (intersection, wattKgData, pulseData) => {
            for (let i = 0; i < wattKgData.length - 1; i++) {
                if ((wattKgData[i] <= intersection && wattKgData[i + 1] >= intersection) ||
                    (wattKgData[i] >= intersection && wattKgData[i + 1] <= intersection)) {
                    const x1 = wattKgData[i], x2 = wattKgData[i + 1];
                    const y1 = pulseData[i], y2 = pulseData[i + 1];
                    return y1 + (intersection - x1) * (y2 - y1) / (x2 - x1);
                }
            }
            return pulseData[0];
        };

        const addRow = () => {
    const table = document.querySelector('#dataTable tbody');
    const newRow = table.insertRow();

    // Add cells for Belastning (Watt), Belastning (Watt/kg), Puls, Laktat, and BORG
    for (let i = 0; i < 5; i++) {
        const newCell = newRow.insertCell();
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'form-control';
        
        if (i === 0) {
            input.oninput = () => calculateWattKg(input); // Attach calculateWattKg to the first column
        } else if (i > 1) { // För Puls (index 2), Laktat (index 3) och BORG (index 4)
            input.oninput = () => updateChart(); // Uppdatera diagrammet när dessa värden ändras
        }
        
        newCell.appendChild(input);
    }
};

        const removeLastRow = () => {
            const table = document.querySelector('#dataTable tbody');
            if (table.rows.length > 0) {
                table.deleteRow(-1); // Remove the last row
                updateChart(); // Uppdatera diagrammet efter att en rad tagits bort
            } else {
                alert("Det finns inga rader att ta bort!"); // Alert if no rows are left
            }
        };

        const formatNumber = (num) => {
            return num.toFixed(2).replace(/\.?0+$/, '');
        };

        const formatPulse = (num) => {
            return Math.round(num);
        };

        document.getElementById('dateInput').valueAsDate = new Date();

        document.getElementById('commentInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        updateAnnotations();

        let verticalLinesVisible = false; // Track the visibility state of the vertical lines

function toggleVerticalLines() {
    verticalLinesVisible = !verticalLinesVisible; // Toggle the visibility state

    // Update the visibility of the vertical lines
    myChart.options.plugins.annotation.annotations.verticalLine1.display = verticalLinesVisible;
    myChart.options.plugins.annotation.annotations.verticalLine2.display = verticalLinesVisible;

    // Update the chart to reflect the changes
    myChart.update();
}

function exportAsJPEG() {
    const element = document.documentElement; // Capture the entire HTML document

    // Get patient data
    const dateInput = document.getElementById('dateInput');
    const nameInput = document.getElementById('nameInput');
    const personnummerInput = document.getElementById('personnummerInput');
    const textarea = document.getElementById('commentInput'); // The Kommentar textarea

    const date = dateInput.value;
    const name = nameInput.value.trim();
    const personnummer = personnummerInput.value.trim();

    // Validate inputs
    if (!date || !name || !personnummer) {
        alert("Vänligen fyll i alla fält (Datum, Namn, Personnummer) innan export.");
        return;
    }

    // Generate filename
    const formattedDate = date.replace(/-/g, ''); // Remove dashes from the date
    const sanitizedName = name.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_'); // Remove special characters and replace spaces with underscores
    const sanitizedPersonnummer = personnummer.replace(/[^a-zA-Z0-9]/g, ''); // Remove special characters
    const filename = `OBLA-Test_${formattedDate}_${sanitizedName}_${sanitizedPersonnummer}.jpeg`;

    // Elements to hide during export
    const elementsToHide = [
        document.querySelector('button[onclick="exportAsJPEG()"]'), // Button for "Spara JPEG"
        document.querySelector('button[onclick="exportAsExcel()"]'), // Button for "Spara Excel"
        document.querySelector('button[onclick="exportAsPDF()"]'), // Button for "Spara PDF"
        document.querySelector('button[onclick="toggleVerticalLines()"]'), // Button for "På/Av Vertikala Linjer"
        document.querySelector('button[onclick="updateChart()"]'), // Button for "Uppdatera Graf"
        document.querySelector('button[onclick="addRow()"]'), // Button for "Lägg till rad"
        document.querySelector('button[onclick="removeLastRow()"]'), // Button for "Ta bort rad"
        document.querySelector('label[for="horizontalLine1"]'), // Label for "Horisontell Linje (2 mmol)"
        document.querySelector('label[for="horizontalLine2"]'), // Label for "Horisontell Linje (4 mmol)"
        document.querySelector('label[for="verticalLine1"]'), // Label for "Vertikal Linje (2 mmol)"
        document.querySelector('label[for="verticalLine2"]'), // Label for "Vertikal Linje (4 mmol)"
        document.getElementById('horizontalLine1'), // Textbox for "Horisontell Linje (2 mmol)"
        document.getElementById('horizontalLine2'), // Textbox for "Horisontell Linje (4 mmol)"
        document.getElementById('verticalLine1'), // Textbox for "Vertikal Linje (2 mmol)"
        document.getElementById('verticalLine2') // Textbox for "Vertikal Linje (4 mmol)"
    ];

    // Hide the specified elements
    elementsToHide.forEach(el => {
        if (el) el.style.display = 'none';
    });

    // Replace the textarea with a styled div for proper rendering
    const textareaDiv = document.createElement('div');
    textareaDiv.innerHTML = textarea.value.replace(/\n/g, '<br>'); // Preserve line breaks
    textareaDiv.style.cssText = `
        display: block;
        white-space: pre-wrap; /* Preserve spaces and line breaks */
        word-wrap: break-word; /* Ensure long words break properly */
        font-family: ${window.getComputedStyle(textarea).fontFamily};
        font-size: ${window.getComputedStyle(textarea).fontSize};
        line-height: ${window.getComputedStyle(textarea).lineHeight};
        padding: ${window.getComputedStyle(textarea).padding};
        border: ${window.getComputedStyle(textarea).border};
        border-radius: ${window.getComputedStyle(textarea).borderRadius};
        width: ${textarea.offsetWidth}px;
        height: ${textarea.offsetHeight}px;
        background: ${window.getComputedStyle(textarea).backgroundColor};
        color: ${window.getComputedStyle(textarea).color};
        margin-top: ${window.getComputedStyle(textarea).marginTop};
        margin-bottom: ${window.getComputedStyle(textarea).marginBottom};
    `;
    textarea.style.display = 'none'; // Hide the original textarea
    textarea.parentNode.insertBefore(textareaDiv, textarea); // Insert the div before the textarea

    // Use html2canvas to export the page
    html2canvas(element, {
        scale: 2, // Increased scale for better quality
        useCORS: true, // Allow cross-origin images
        scrollX: 0, // Ensure no horizontal scrolling
        scrollY: 0, // Start rendering from the top of the page
        windowWidth: document.documentElement.scrollWidth, // Full page width
        windowHeight: document.documentElement.scrollHeight, // Full page height
        backgroundColor: '#F0EEEC',
        ignoreElements: (element) => {
            return element === textareaDiv;
        }
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = filename; // Use the dynamically generated filename
        link.href = canvas.toDataURL('image/jpeg', 1.0); // Convert canvas to JPEG
        link.click();

        // Restore the original textarea and remove the temporary div
        textarea.style.display = 'block';
        textareaDiv.remove();

        // Show the hidden elements again
        elementsToHide.forEach(el => {
            if (el) el.style.display = 'block';
        });
    }).catch(error => {
        console.error("An error occurred while exporting the page as JPEG:", error);
        alert("Ett fel inträffade vid exporten. Kontrollera konsolen för mer information.");

        // Restore the original textarea and remove the temporary div in case of an error
        textarea.style.display = 'block';
        textareaDiv.remove();

        // Show the hidden elements again
        elementsToHide.forEach(el => {
            if (el) el.style.display = 'block';
        });
    });
}

function exportAsExcel() {
    // Hämta data från input-fälten
    const date = document.getElementById('dateInput').value;
    const name = document.getElementById('nameInput').value.trim();
    const personnummer = document.getElementById('personnummerInput').value.trim();
    const weight = document.getElementById('weightInput').value;
    const comment = document.getElementById('commentInput').value.trim(); // Hämta kommentaren

    // Validera att obligatoriska fält är ifyllda
    if (!date || !name || !personnummer) {
        alert("Vänligen fyll i alla fält (Datum, Namn, Personnummer) innan export.");
        return;
    }

    // Hämta tröskeldata
    const watt2 = document.getElementById('watt2').value;
    const wattKg2 = document.getElementById('wattKg2').value;
    const pulse2 = document.getElementById('pulse2').value;

    const watt4 = document.getElementById('watt4').value;
    const wattKg4 = document.getElementById('wattKg4').value;
    const pulse4 = document.getElementById('pulse4').value;

    // Hämta tabelldata från dataTable
    const tableData = [];
    document.querySelectorAll('#dataTable tbody tr').forEach(row => {
        const cells = row.querySelectorAll('input');
        if (cells.length >= 5) {
            tableData.push([
                cells[0].value, // Belastning (Watt)
                cells[1].value, // Belastning (Watt/kg)
                cells[2].value, // Puls
                cells[3].value, // Laktat
                cells[4].value  // BORG
            ]);
        }
    });

    // Förbered data för Excel-filen
    const data = [
        // Tröskelvärden (första raden)
        [
            'Datum', 'Personnummer', 'Namn', 'Vikt', 
            'Tröskel 2.0 mMol/l Belastning (Watt)', 'Tröskel 2.0 mMol/l Belastning (Watt/kg)', 'Tröskel 2.0 mMol/l Puls',
            'Tröskel 4.0 mMol/l Belastning (Watt)', 'Tröskel 4.0 mMol/l Belastning (Watt/kg)', 'Tröskel 4.0 mMol/l Puls',
            'Kommentar'
        ],
        [
            date, personnummer, name, weight, 
            watt2, wattKg2, pulse2, 
            watt4, wattKg4, pulse4, 
            comment
        ],
        // Tom rad för separation
        [],
        // Tabelldata header
        ['Mätdata:', '', '', '', '', '', '', '', '', '', ''],
        ['Belastning (Watt)', 'Belastning (Watt/kg)', 'Puls', 'Laktat', 'BORG', '', '', '', '', '', '']
    ];

    // Lägg till tabelldata
    tableData.forEach(row => {
        data.push([row[0], row[1], row[2], row[3], row[4], '', '', '', '', '', '']);
    });

    // Skapa en ny arbetsbok och ett kalkylblad
    const workbook = XLSX.utils.book_new();
    const worksheet = XLSX.utils.aoa_to_sheet(data);

    // Lägg till kalkylbladet i arbetsboken
    XLSX.utils.book_append_sheet(workbook, worksheet, 'OBLA-Test');

    // Generera filnamn
    const formattedDate = date.replace(/-/g, ''); // Ta bort bindestreck från datumet
    const sanitizedName = name.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_'); // Ta bort specialtecken och ersätt mellanslag med understreck
    const sanitizedPersonnummer = personnummer.replace(/[^a-zA-Z0-9]/g, ''); // Ta bort specialtecken
    const filename = `OBLA-Test-Cykel_${formattedDate}_${sanitizedName}_${sanitizedPersonnummer}.xlsx`;

    // Spara Excel-filen
    XLSX.writeFile(workbook, filename);
}

function exportAsPDF() {
    // Hämta jsPDF från window
    const { jsPDF } = window.jspdf;
    
    // Get patient data
    const dateInput = document.getElementById('dateInput');
    const nameInput = document.getElementById('nameInput');
    const personnummerInput = document.getElementById('personnummerInput');
    const textarea = document.getElementById('commentInput');
    
    const date = dateInput.value;
    const name = nameInput.value.trim();
    const personnummer = personnummerInput.value.trim();
    
    // Validate inputs
    if (!date || !name || !personnummer) {
        alert("Vänligen fyll i alla fält (Datum, Namn, Personnummer) innan export.");
        return;
    }
    
    // Create overlay div to block UI interactions during processing
    const overlayDiv = document.createElement('div');
    overlayDiv.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        z-index: 9998;
    `;
    
    // Skapa en laddningsindikator som visas under processen
    const loadingIndicator = document.createElement('div');
    loadingIndicator.innerText = 'Skapar PDF, var god vänta...';
    loadingIndicator.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 9999;
    `;
    
    // Add the overlay and loading indicator to the DOM
    document.body.appendChild(overlayDiv);
    document.body.appendChild(loadingIndicator);
    
    // Generate filename
    const formattedDate = date.replace(/-/g, '');
    const sanitizedName = name.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_');
    const sanitizedPersonnummer = personnummer.replace(/[^a-zA-Z0-9]/g, '');
    const filename = `OBLA-Test_${formattedDate}_${sanitizedName}_${sanitizedPersonnummer}.pdf`;
    
    // Elements to hide during export
    const elementsToHide = [
        document.querySelector('button[onclick="exportAsJPEG()"]'),
        document.querySelector('button[onclick="exportAsExcel()"]'),
        document.querySelector('button[onclick="exportAsPDF()"]'),
        document.querySelector('button[onclick="toggleVerticalLines()"]'),
        document.querySelector('button[onclick="updateChart()"]'),
        document.querySelector('button[onclick="addRow()"]'),
        document.querySelector('button[onclick="removeLastRow()"]'),
        document.querySelector('label[for="horizontalLine1"]'),
        document.querySelector('label[for="horizontalLine2"]'),
        document.querySelector('label[for="verticalLine1"]'),
        document.querySelector('label[for="verticalLine2"]'),
        document.getElementById('horizontalLine1'),
        document.getElementById('horizontalLine2'),
        document.getElementById('verticalLine1'),
        document.getElementById('verticalLine2')
    ];
    
    // Hide the specified elements
    elementsToHide.forEach(el => {
        if (el) el.style.display = 'none';
    });
    
    // Replace the textarea with a styled div for proper rendering
    const textareaDiv = document.createElement('div');
    textareaDiv.innerHTML = textarea.value.replace(/\n/g, '<br>');
    textareaDiv.style.cssText = `
        display: block;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: ${window.getComputedStyle(textarea).fontFamily};
        font-size: ${window.getComputedStyle(textarea).fontSize};
        line-height: ${window.getComputedStyle(textarea).lineHeight};
        padding: ${window.getComputedStyle(textarea).padding};
        border: ${window.getComputedStyle(textarea).border};
        border-radius: ${window.getComputedStyle(textarea).borderRadius};
        width: ${textarea.offsetWidth}px;
        height: ${textarea.offsetHeight}px;
        background: ${window.getComputedStyle(textarea).backgroundColor};
        color: ${window.getComputedStyle(textarea).color};
        margin-top: ${window.getComputedStyle(textarea).marginTop};
        margin-bottom: ${window.getComputedStyle(textarea).marginBottom};
    `;
    textarea.style.display = 'none';
    textarea.parentNode.insertBefore(textareaDiv, textarea);
    
    // Temporarily scale up important elements for better PDF rendering
    const chartContainer = document.getElementById('chartContainer');
    const thresholdTable = document.getElementById('thresholdTable');
    const originalChartStyle = chartContainer.style.cssText;
    const originalTableStyle = thresholdTable.style.cssText;
    
    // Make chart and tables larger for landscape orientation
    chartContainer.style.cssText = `
        width: 85% !important;
        max-width: none !important;
        margin: 20px auto !important;
        height: auto !important;
    `;
    
    thresholdTable.style.cssText = `
        width: 85% !important;
        max-width: none !important;
        margin: 20px auto !important;
        font-size: 1.1em !important;
    `;
    
    // Use setTimeout to ensure loading indicator is visible before heavy processing begins
    setTimeout(() => {
        // Initialize PDF object in landscape orientation
        const pdf = new jsPDF('l', 'pt', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        
        // Set background color for PDF
        pdf.setFillColor(240, 238, 236);
        pdf.rect(0, 0, pageWidth, pageHeight, 'F');
        
        // Add title
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(24);
        pdf.setTextColor(68, 68, 68);
        const title = 'SENTION - Onset of Blood Lactate Accumulation';
        const titleWidth = pdf.getTextWidth(title);
        const titleX = (pageWidth - titleWidth) / 2;
        pdf.text(title, titleX, 50);
        
        // Get the chart container
        const chartContainer = document.getElementById('chartContainer');
        
        // Use html2canvas with optimized settings
        html2canvas(chartContainer, {
            scale: 2, // Increased scale for better quality
            useCORS: true,
            scrollX: 0,
            scrollY: 0,
            windowWidth: chartContainer.offsetWidth + 100, // Extra width to capture right axis
            windowHeight: chartContainer.offsetHeight + 50, // Extra height for safety
            backgroundColor: '#F0EEEC',
            ignoreElements: (element) => {
                return element === loadingIndicator;
            }
        }).then(canvas => {
            // Convert canvas to image data with maximum quality
            const imgData = canvas.toDataURL('image/png', 1.0); // Use PNG for better quality
            
            // Calculate dimensions to fit properly ensuring right side is visible
            const availableHeight = pageHeight - 80; // Even smaller margin for maximum diagram size
            const availableWidth = pageWidth - 60; // Minimal margins for maximum diagram size
            const aspectRatio = canvas.width / canvas.height;
            
            let imgWidth = availableWidth * 0.96; // Use 96% of available width for maximum diagram size
            let imgHeight = imgWidth / aspectRatio;
            
            // If height is too tall, scale based on available height
            if (imgHeight > availableHeight * 0.96) {
                imgHeight = availableHeight * 0.96; // Use 96% of available height
                imgWidth = imgHeight * aspectRatio;
            }
            
            // Center the image horizontally and vertically
            const xOffset = (pageWidth - imgWidth) / 2;
            
            // Calculate vertical centering: equal space from title to diagram and diagram to logo
            const titleSpace = 80; // Space taken by title + margin
            const logoSpace = 80; // Space taken by logo + margin at bottom
            const availableVerticalSpace = pageHeight - titleSpace - logoSpace;
            const yOffset = titleSpace + (availableVerticalSpace - imgHeight) / 2; // Center vertically
            
            // Add image to PDF with highest quality
            pdf.addImage(
                imgData,
                'PNG', // Use PNG for better quality
                xOffset,
                yOffset,
                imgWidth,
                imgHeight,
                undefined,
                'SLOW' // Use SLOW for best quality instead of FAST
            );
            
            // Lägg till identifiering i nedre vänstra hörnet
            const tolkatAvDropdown = document.getElementById("interpretedBy");
            const tolkatAv = tolkatAvDropdown.options[tolkatAvDropdown.selectedIndex].text;
            const footerText = `${name} | ${personnummer} | OBLA-test Cykel ${date} | Tolkat av: ${tolkatAv}`;
            pdf.setFontSize(10);
            pdf.setTextColor(100, 100, 100); // Diskret mörkgrå färg
            pdf.text(footerText, 20, pageHeight - 10);
            
            // Save the PDF with generated filename
            pdf.save(filename);
            
            // Clean up
            document.body.removeChild(loadingIndicator);
            document.body.removeChild(overlayDiv);
            
            // Restore original styles
            chartContainer.style.cssText = originalChartStyle;
            thresholdTable.style.cssText = originalTableStyle;
            
            // Restore the textarea and remove temporary div
            textarea.style.display = 'block';
            textareaDiv.remove();
            
            // Show the hidden elements again
            elementsToHide.forEach(el => {
                if (el) el.style.display = 'block';
            });
        }).catch(error => {
            console.error("Ett fel inträffade vid PDF-exporten:", error);
            alert("Ett fel inträffade vid PDF-exporten. Kontrollera konsolen för mer information.");
            
            // Clean up in case of error
            if (document.body.contains(loadingIndicator)) {
                document.body.removeChild(loadingIndicator);
            }
            if (document.body.contains(overlayDiv)) {
                document.body.removeChild(overlayDiv);
            }
            
            // Restore original styles
            chartContainer.style.cssText = originalChartStyle;
            thresholdTable.style.cssText = originalTableStyle;
            
            // Restore the textarea and remove temporary div
            textarea.style.display = 'block';
            if (textareaDiv.parentNode) {
                textareaDiv.remove();
            }
            
            // Show the hidden elements again
            elementsToHide.forEach(el => {
                if (el) el.style.display = 'block';
            });
        });
    }, 100);
}

function exportDiagramAsPDF() {
    // Get patient data
    const dateInput = document.getElementById('dateInput');
    const nameInput = document.getElementById('nameInput');
    const personnummerInput = document.getElementById('personnummerInput');

    const date = dateInput.value;
    const name = nameInput.value.trim();
    const personnummer = personnummerInput.value.trim();

    // Validate inputs
    if (!date || !name || !personnummer) {
        alert("Vänligen fyll i alla fält (Datum, Namn, Personnummer) innan export.");
        return;
    }

    // Generate filename
    const formattedDate = date.replace(/-/g, ''); // Remove dashes from the date
    const sanitizedName = name.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_'); // Remove special characters and replace spaces with underscores
    const sanitizedPersonnummer = personnummer.replace(/[^a-zA-Z0-9]/g, ''); // Remove special characters
    const filename = `OBLA-Test-Cykel_Diagram_${formattedDate}_${sanitizedName}_${sanitizedPersonnummer}.pdf`;

    // Create loading indicator
    const loadingIndicator = document.createElement('div');
    loadingIndicator.innerText = 'Skapar PDF, var god vänta...';
    loadingIndicator.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 9999;
    `;
    document.body.appendChild(loadingIndicator);

    // Use setTimeout to ensure chart is fully rendered
    setTimeout(() => {
        // Initialize PDF in landscape orientation
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('l', 'pt', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        // Set background color
        pdf.setFillColor(240, 238, 236);
        pdf.rect(0, 0, pageWidth, pageHeight, 'F');

        // Add title
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(24);
        pdf.setTextColor(68, 68, 68);
        const title = 'Onset of Blood Lactate Accumulation';
        const titleWidth = pdf.getTextWidth(title);
        const titleX = (pageWidth - titleWidth) / 2;
        pdf.text(title, titleX, 50);

        // Get the chart container
        const chartContainer = document.getElementById('chartContainer');
        
        // Use html2canvas with optimized settings
        html2canvas(chartContainer, {
            scale: 2, // Increased scale for better quality
            useCORS: true,
            scrollX: 0,
            scrollY: 0,
            windowWidth: chartContainer.offsetWidth + 100, // Extra width to capture right axis
            windowHeight: chartContainer.offsetHeight + 50, // Extra height for safety
            backgroundColor: '#F0EEEC',
            ignoreElements: (element) => {
                return element === loadingIndicator;
            }
        }).then(canvas => {
            // Convert canvas to image data with high quality
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            
            // Calculate dimensions to fit properly ensuring right side is visible
            const availableHeight = pageHeight - 80; // Even smaller margin for maximum diagram size
            const availableWidth = pageWidth - 60; // Minimal margins for maximum diagram size
            const aspectRatio = canvas.width / canvas.height;
            
            let imgWidth = availableWidth * 0.96; // Use 96% of available width for maximum diagram size
            let imgHeight = imgWidth / aspectRatio;
            
            // If height is too tall, scale based on available height
            if (imgHeight > availableHeight * 0.96) {
                imgHeight = availableHeight * 0.96; // Use 96% of available height
                imgWidth = imgHeight * aspectRatio;
            }
            
            // Center the image horizontally and vertically
            const xOffset = (pageWidth - imgWidth) / 2;
            
            // Calculate vertical centering: equal space from title to diagram and diagram to logo
            const titleSpace = 80; // Space taken by title + margin
            const logoSpace = 80; // Space taken by logo + margin at bottom
            const availableVerticalSpace = pageHeight - titleSpace - logoSpace;
            const yOffset = titleSpace + (availableVerticalSpace - imgHeight) / 2; // Center vertically
            
            // Add image to PDF
            pdf.addImage(
                imgData,
                'JPEG',
                xOffset,
                yOffset,
                imgWidth,
                imgHeight,
                undefined,
                'FAST'
            );

            // Add the Sention logo
            const logoImg = new Image();
            logoImg.src = 'https://i.postimg.cc/x1PkvmGq/SENTION-logo-Black-Transparent-BG.png';
            logoImg.onload = function() {
                const logoWidth = 60; // Changed from 80 to 60 to match threshold table PDF
                const logoHeight = logoWidth * (logoImg.height / logoImg.width);
                const logoX = pageWidth - logoWidth - 20;
                const logoY = pageHeight - logoHeight - 20;

                pdf.addImage(
                    logoImg,
                    'PNG',
                    logoX,
                    logoY,
                    logoWidth,
                    logoHeight
                );

                // Lägg till identifiering i nedre vänstra hörnet
                const tolkatAvDropdown = document.getElementById("interpretedBy");
                const tolkatAv = tolkatAvDropdown.options[tolkatAvDropdown.selectedIndex].text;
                const footerText = `${name} | ${personnummer} | OBLA-test Cykel ${date} | Tolkat av: ${tolkatAv}`;
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100); // Diskret mörkgrå färg
                pdf.text(footerText, 20, pageHeight - 10);

                // Save the PDF with generated filename
                pdf.save(filename);

                // Cleanup
                document.body.removeChild(loadingIndicator);
            };
        }).catch(error => {
            console.error("Error capturing chart:", error);
            alert("Ett fel inträffade vid exporten av diagrammet.");
            document.body.removeChild(loadingIndicator);
        });
    }, 100);
}

function exportThresholdTableAsPDF() {
    // Get patient data
    const dateInput = document.getElementById('dateInput');
    const nameInput = document.getElementById('nameInput');
    const personnummerInput = document.getElementById('personnummerInput');

    const date = dateInput.value;
    const name = nameInput.value.trim();
    const personnummer = personnummerInput.value.trim();

    // Validate inputs
    if (!date || !name || !personnummer) {
        alert("Vänligen fyll i alla fält (Datum, Namn, Personnummer) innan export.");
        return;
    }

    // Generate filename
    const formattedDate = date.replace(/-/g, ''); // Remove dashes from the date
    const sanitizedName = name.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_'); // Remove special characters and replace spaces with underscores
    const sanitizedPersonnummer = personnummer.replace(/[^a-zA-Z0-9]/g, ''); // Remove special characters
    const filename = `OBLA-Test-Cykel_Troskeldata_${formattedDate}_${sanitizedName}_${sanitizedPersonnummer}.pdf`;

    // Create loading indicator
    const loadingIndicator = document.createElement('div');
    loadingIndicator.innerText = 'Skapar PDF, var god vänta...';
    loadingIndicator.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 9999;
    `;
    document.body.appendChild(loadingIndicator);

    // Create a temporary container
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = `
        position: fixed;
        left: -9999px;
        width: 800px;
        background-color: #F0EEEC;
        padding: 20px;
        font-family: 'Rajdhani', sans-serif;
    `;
    document.body.appendChild(tempContainer);

    // Add the data table
    const dataTable = document.createElement('div');
    dataTable.innerHTML = `
        <h3 style="margin-bottom: 20px;">Mätdata</h3>
        <table style="width: 100%; margin-bottom: 30px; border-collapse: collapse; background-color: #e0e0e0;">
            <thead>
                <tr>
                    <th style="padding: 10px; background-color: #d0d0d0; border: 1px solid #ccc;">Belastning (Watt)</th>
                    <th style="padding: 10px; background-color: #d0d0d0; border: 1px solid #ccc;">Belastning (Watt/kg)</th>
                    <th style="padding: 10px; background-color: #d0d0d0; border: 1px solid #ccc;">Puls</th>
                    <th style="padding: 10px; background-color: #d0d0d0; border: 1px solid #ccc;">Laktat</th>
                    <th style="padding: 10px; background-color: #d0d0d0; border: 1px solid #ccc;">BORG</th>
                </tr>
            </thead>
            <tbody>
                ${Array.from(document.querySelectorAll('#dataTable tbody tr')).map(row => `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">${row.cells[0].querySelector('input').value}</td>
                        <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">${row.cells[1].querySelector('input').value}</td>
                        <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">${row.cells[2].querySelector('input').value}</td>
                        <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">${row.cells[3].querySelector('input').value}</td>
                        <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">${row.cells[4].querySelector('input').value}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    tempContainer.appendChild(dataTable);

    // Add the threshold table with a header
    const thresholdHeader = document.createElement('h3');
    thresholdHeader.textContent = 'Tröskelvärden';
    thresholdHeader.style.marginBottom = '20px';
    tempContainer.appendChild(thresholdHeader);

    // Clone the threshold table
    const tableClone = document.getElementById('thresholdTable').cloneNode(true);
    tempContainer.appendChild(tableClone);

    // Initialize PDF in landscape orientation
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('l', 'pt', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    // Set background color
    pdf.setFillColor(240, 238, 236);
    pdf.rect(0, 0, pageWidth, pageHeight, 'F');

    // Use html2canvas to capture the temporary container
    html2canvas(tempContainer, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#F0EEEC'
    }).then(canvas => {
        // Calculate dimensions to fit the page
        const aspectRatio = canvas.width / canvas.height;
        let imgWidth = pageWidth - 80; // 40px margin on each side
        let imgHeight = imgWidth / aspectRatio;

        if (imgHeight > pageHeight - 80) {
            imgHeight = pageHeight - 80;
            imgWidth = imgHeight * aspectRatio;
        }

        // Center the image
        const xOffset = (pageWidth - imgWidth) / 2;
        const yOffset = 40; // Position at top with margin

        // Add the table image
        pdf.addImage(
            canvas.toDataURL('image/jpeg', 1.0),
            'JPEG',
            xOffset,
            yOffset,
            imgWidth,
            imgHeight
        );

        // Add the Sention logo
        const logoImg = new Image();
        logoImg.src = 'https://i.postimg.cc/x1PkvmGq/SENTION-logo-Black-Transparent-BG.png';
        logoImg.onload = function() {
            const logoWidth = 60;
            const logoHeight = logoWidth * (logoImg.height / logoImg.width);
            const logoX = pageWidth - logoWidth - 20;
            const logoY = pageHeight - logoHeight - 20;

            pdf.addImage(
                logoImg,
                'PNG',
                logoX,
                logoY,
                logoWidth,
                logoHeight
            );

            // Lägg till identifiering i nedre vänstra hörnet
            const tolkatAvDropdown = document.getElementById("interpretedBy");
            const tolkatAv = tolkatAvDropdown.options[tolkatAvDropdown.selectedIndex].text;
            const footerText = `${name} | ${personnummer} | OBLA-test Cykel ${date} | Tolkat av: ${tolkatAv}`;
            pdf.setFontSize(10);
            pdf.setTextColor(100, 100, 100); // Diskret mörkgrå färg
            pdf.text(footerText, 20, pageHeight - 10);

            // Save the PDF with generated filename
            pdf.save(filename);

            // Cleanup
            document.body.removeChild(tempContainer);
            document.body.removeChild(loadingIndicator);
        };
    });
}

    </script>
</body>
</html>